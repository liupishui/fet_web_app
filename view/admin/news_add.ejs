
<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta name="viewport"
        content="width=device-width,initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0">
    <title>文章添加-管理中心</title>
    <link href="static/css/bootstrap.min14ed.css?v=3.3.6" rel="stylesheet">
    <link href="static/css/font-awesome.min93e3.css?v=4.4.0" rel="stylesheet">
    <link href="static/css/plugins/bootstrap-table/bootstrap-table.min.css" rel="stylesheet">
    <link href="static/css/animate.min.css" rel="stylesheet">
    <link href="static/css/style.min862f.css?v=4.1.0" rel="stylesheet">
</head>

<body class="gray-bg">
    <div class="wrapper wrapper-content">
        <div class="row">
            <div class="col-sm-12">
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <h5>发布<%= categoryPidInfo.name;%></h5>
                        <div class="ibox-tools">
                            <a class="collapse-link">
                                <i class="fa fa-chevron-up"></i>
                            </a>
                            <a class="dropdown-toggle" data-toggle="dropdown" href="form_basic.html#">
                                <i class="fa fa-wrench"></i>
                            </a>
                            <ul class="dropdown-menu dropdown-user">
                                <li><a href="form_basic.html#">选项1</a>
                                </li>
                                <li><a href="form_basic.html#">选项2</a>
                                </li>
                            </ul>
                            <a class="close-link">
                                <i class="fa fa-times"></i>
                            </a>
                        </div>
                    </div>
                    <div class="ibox-content">
                        <form class="form-horizontal m-t">
                            <% if (categoryPid==1) { %>
                                <div class="form-group" style="display:none">
                                    <label class="col-sm-3 control-label">
                                        选择发布平台
                                    </label>
                                    <div class="col-sm-8">
                                        <label>
                                            <input type="radio" value="0" checked name="platform"/>
                                                网页
                                        </label>
                                        <label>
                                            <input type="radio" value="1" name="platform"/>
                                                小程序
                                        </label>
                                    </div>
                                </div>
                            <% } %>    
                            <div class="form-group">
                                <label class="col-sm-3 control-label">所属分类：</label>
                                <div class="col-sm-8">
                                    <select class="form-control input-s-sm" id="category">
                                        <option value="-1">-- 请选择 --</option>
                                        <% categorySon.forEach(element => { %>
                                            <option value="<%=element.id;%>"><%= "----".repeat(element.level);%><%= element.name;%></option>
                                        <% }) %>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label"><i class="text-danger">*</i> 文章标题：</label>
                                <div class="col-sm-8">
                                    <input  class="form-control" id="title" type="text" placeholder="必须填写" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">关键词：</label>
                                <div class="col-sm-8">
                                    <input class="form-control" type="text" id="keywords" placeholder="好的关键字有利于SEO，关键字用英文的逗号分割">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">描述：</label>
                                <div class="col-sm-8">
                                    <textarea class="form-control" cols="30" rows="2" id="description" placeholder="描述写好，文章容易被收录"></textarea>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">摘要：</label>
                                <div class="col-sm-8">
                                    <textarea class="form-control" cols="30" rows="2" id="excerpt" placeholder="请输入摘要(如果是发布新闻则必填)"></textarea>
                                </div>
                            </div>
                            <div class="form-group from-group-product_img">
                                <label class="col-sm-3 control-label"><i class="text-danger">*</i> 封面：</label>
                                <div class="col-sm-8">
                                    <div class="form-control" style="border:none;height:auto;font-size:0;line-height:0;"></div>
                                    <label for="banner" id="banner" data-cropper-option='{"width":800,"height":400}' class="btn-add">
                                        <span class="btn btn-primary">点击上传</span>
                                    </label>
                                    <span class="help-block m-b-none"><i class="fa fa-info-circle"></i>建议尺寸540*381(大约3:2)的长方形图片</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label"><i class="text-danger">*</i> 内容详情：</label>
                                <div class="col-sm-8">
                                    <textarea placeholder="" id="content" style="height: 420px;" placeholder="内容详情"></textarea>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">显示顺序：</label>
                                <div class="col-sm-8">
                                    <input class="form-control" type="text" id="sort" placeholder="默认99，数字越小显示越靠前">
                                </div>
                            </div>
                            <div class="form-group from-group-product_img">
                                <label class="col-sm-3 control-label">附件：</label>
                                <div class="col-sm-8">
                                    <div class="form-control" style="border:none;height:auto;font-size:0;line-height:0;"></div>
                                    <label for="attached_file_link" id="attached_file_link" class="btn-add">
                                        <span class="btn btn-primary">点击上传</span>
                                    </label>
                                    <span class="help-block m-b-none"><i class="fa fa-info-circle"></i>建议附件大小不超过200M</span>
                                </div>
                            </div>
                            <div class="form-group form-group-tag">
                                <label class="col-sm-3 control-label">标签：</label>
                                <div class="col-sm-8">
                                    <% tags.forEach(element => { %>
                                     <div class="btn btn-default" tagid="<%= element.id;%>" category="<%= element.news_categories_id;%>"><%= element.name;%></div>
                                    <% }) %>
                                    <div class="btn btn-warning" style="margin-left:10px;" id="tag_add"><span class="fa fa-plus"></span></div>
                                </div>
                            </div>

                            <div class="form-group">
                                <div class="col-sm-8 col-sm-offset-3">
                                    <button class="btn btn-primary btn-submit" type="button">提交</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

</body>

<script src="static/js/jquery.min.js?v=2.1.4"></script>
<script src="static/js/bootstrap.min.js?v=3.3.6"></script>
<script src="static/js/plugins/layer/layer.min.js"></script>
<script type="text/javascript" src="/admin/scripts/ueditor/ueditor.config.js"></script>
<script type="text/javascript" src="/admin/scripts/ueditor/ueditor.all.js"></script>
<script type="text/javascript" src="scripts/fcup/fcup.js"></script>
<script src="scripts/common.js"></script>

<script type="text/javascript">
    $("#tag_add").click(function(){
        var $tagaAdd = $("<input type='text' placeholder='请输入新标签' class='form-control tagAdd' style='width:140px;display:inline-block;margin-left:10px;'/>");
        $(this).before($tagaAdd);
        $tagaAdd.focus();        
    });
    $("select").change(function(){
        $("#tag_add").prevAll().hide();
        $("#tag_add").prevAll().each(function(){
            $(this).removeClass('btn-danger');
        });
        var $that = $(this);
        console.log($that.val());
        $("#tag_add").prevAll().filter(function(){ 
            return $(this).attr('category')==$that.val() 
            }).show();
    });

    $(".form-group-tag").delegate('.btn-default','click',function(){
        $(this).toggleClass('btn-danger');
    })

    $("body").delegate('.tagAdd','blur',function(){
        //添加新标签
        if($("select").val()==-1){
            $(this).remove();
            alert('请选择分类');
            return;
        }
        if($.trim($(".tagAdd").val())!=''){
            var $that = $(this);
            var isHasTag = false;
            $(this).prevAll().filter(function(){ return $(this).is(':visible');}).each(function(){
                if($(this).text()==$.trim($(".tagAdd").val())){
                    isHasTag = true;
                    alert('标签已经存在，请勿重复添加');
                }
            });
            if(isHasTag == false){
                $.post('/admin/tag_add',{
                    "type":"tagAdd"
                    ,'news_categories_id':$("select").val()
                    ,"name":$.trim($(".tagAdd").val())
                },function(data){
                    if(data){
                        if(data.msg=="添加成功"){
                            $that.before($("<div class='btn btn-default btn-danger' tagid='"+ data +"' category='"+ $("select").val() +"'>"+ $.trim($that.val()) +"</div>"));
                            $that.remove();
                        }else{
                            layer.msg(data.msg);
                        }

                    }else{
                        layer.msg('添加标签失败，请重新添加')
                    }
                });
            }
        }else{
            $(this).remove();
        }
    });


    //图片上传
    uploadImgFcup('banner');
    //附件上传
    attached_file_Upload('attached_file_link');

    $("#content").width($("#content").parent().width());
    var ue = UE.getEditor('content', { initialFrameWidth: null,autoFloatEnabled:false,toolbars: [[
            'fullscreen', 'source', '|', 'undo', 'redo', '|',
            'bold', 'italic', 'underline', 'fontborder', 'strikethrough', 'superscript', 'subscript', 'removeformat', 'formatmatch', 'autotypeset', 'blockquote', 'pasteplain', '|', 'forecolor', 'backcolor', 'insertorderedlist', 'insertunorderedlist', 'selectall', 'cleardoc', '|',
            'rowspacingtop', 'rowspacingbottom', 'lineheight', '|',
            'customstyle', 'paragraph', 'fontfamily', 'fontsize', '|',
            'directionalityltr', 'directionalityrtl', 'indent', '|',
            'justifyleft', 'justifycenter', 'justifyright', 'justifyjustify', '|', 'touppercase', 'tolowercase', '|',
            'link', 'unlink', 'anchor', '|', 'imagenone', 'imageleft', 'imageright', 'imagecenter', '|',
            'simpleupload', 'insertimage', 'emotion', 'scrawl', 'insertvideo', 'music', 'attachment', 'map',  'insertframe', 'insertcode', 'pagebreak', 'template', 'background', '|',
            'horizontal', 'date', 'time', 'spechars', 'snapscreen', 'wordimage', '|',
            'inserttable', 'deletetable', 'insertparagraphbeforetable', 'insertrow', 'deleterow', 'insertcol', 'deletecol', 'mergecells', 'mergeright', 'mergedown', 'splittocells', 'splittorows', 'splittocols', 'charts', '|',
            'print', 'preview', 'searchreplace', 'drafts', 'help'
        ]]});
    $(function(){
        //添加新闻
        <% if(modifyId===0) {%>
        $(".btn-submit").click(function(){
            var canInsert = true;
            var addNews = true;
            if(!addNews){
                return;
            };
            if($("select").val()==-1){
                layer.msg('请选择分类',{time:3000});
                return;
            }
            var tags = '';
            $(".form-group-tag .btn-danger").each(function(){
                tags += $(this).attr('tagid')+',';
            });
            var poster=$("#banner").prev().find('img').attr('src')?$("#banner").prev().find('img').attr('src').split('?')[0]:'';
            if(poster==''){
                layer.msg('请上传封面图片!');
                return;
            }
            if($.trim($("#title").val())==""){
                canInsert = false;
                layer.msg('请输入新闻标题');
            }else if($.trim(ue.getContent())==""){
                canInsert = false;
                layer.msg('请输入新闻内容');
            }else{
                $.post('/admin/news_add',{
                    type:'articleAdd',
                    'platform':$("[name=platform]:checked").val(),
                    'category_id':$("select").val(),
                    'title':$.trim($("#title").val()),
                    'poster':$("#banner").prev().find('img').attr('src')?$("#banner").prev().find('img').attr('src').split('?')[0]:'',
                    'keywords':$.trim($("#keywords").val()),
                    'description':$.trim($("#description").val()),
                    'excerpt':$.trim($("#excerpt").val()),
                    'content':ue.getContent(),
                    'sort':$.trim($("#sort").val()),
                    'attached_file_link':$("#attached_file_link").prev().find('a').attr('href'),
                    'attached_file_name':$("#attached_file_link").prev().find('a').text(),
                    'tags':tags
                },function(data){
                    if (data) {
                        resetForm();
                        layer.confirm(data,{btn:['继续添加','跳转列表']}, function(index){
                            layer.close(index);
                            },function(index){
                                layer.close(index);
                                var categoryPidInfo = <%- categoryPidInfo.id %>;
                                if(categoryPidInfo==1){
                                    window.top.openMenu($(window.top.document).find('[data-index=10]'));
                                    window.top.freshList();
                                }
                                if(categoryPidInfo==2){
                                    window.top.openMenu($(window.top.document).find('[data-index=5]'));
                                    window.top.freshCaseList();
                                }
                                if(categoryPidInfo==3){
                                    window.top.openMenu($(window.top.document).find('[data-index=6]'));
                                    window.top.freshProductList();
                                }
                        });

                    }else{
                        layer.msg('提交失败，请重新提交',{time:600},function(){
                        });
                    }
                })
            }
        });
        <% } %>
        //修改新闻
        <% if(modifyId!==0) { %>
            //获取修改新闻内容
            $.get('/admin/news_add?modify=<%- modifyId -%>',function(data){
                var newsArticle = data;
                $("[name=platform][value="+newsArticle.platform+"]").prop('checked',true);
                $("select").val(newsArticle.category_id);
                $("[name=categories][value="+newsArticle.category_id+"]").prop('checked',true);
                $("#banner").prev().html($('<img style="width:150px;" class="cropper" data-org="' + newsArticle.poster_org + '" data-width="800" data-height="400" class="poster" src="'+newsArticle.poster+'" alt="">'));
                $("#title").val(newsArticle.title);
                $("#keywords").val(newsArticle.keywords);
                $("#description").val(newsArticle.description);
                $("#excerpt").val(newsArticle.excerpt);
                $("#sort").val(newsArticle.sort);
                if(newsArticle.attached_file_link!=''&&newsArticle.attached_file_link!=null){
                    $("#attached_file_link").prev().html($("<a href='" + newsArticle.attached_file_link + "' downlaod='" + newsArticle.attached_file_name + "' class='btn btn-error'><span class='fa fa-file fw m-r'></span>" + newsArticle.attached_file_name + "</a>"));
                }
                ue.ready(function(){
                    ue.setContent(newsArticle.content);
                });
                //标签初始化
                $("#tag_add").prevAll().hide();
                $("#tag_add").prevAll().each(function(){
                    $(this).removeClass('btn-danger');
                });
                $.each(newsArticle.tags.split(','),function(key,val){
                    if(val!=''){
                        $('[tagid='+val+']').addClass('btn-danger');
                    }
                });
                $("#tag_add").prevAll().filter(function(){ 
                    return $(this).attr('category')==$('select').val() 
                    }).show();
                })
            //上传修改内容
            $(".btn-submit").click(function(){
                if($("select").val()==-1){
                    layer.msg('请选择分类',{time:3000});
                    return;
                }
                var tags = '';
                $(".form-group-tag .btn-danger").each(function(){
                    tags += $(this).attr('tagid')+',';
                });
                var canInsert = true;
                if($.trim($("#title").val())==""){
                    canInsert = false;
                    layer.msg('请输入新闻标题');
                }else if($.trim(ue.getContent())==""){
                    canInsert = false;
                    layer.msg('请输入新闻内容');
                }else{
                    $.post('/admin/news_add',{
                        type:'articleUpdate',
                        'modify':<%- modifyId %>,
                        'category_id':$("select").val(),
                        'title':$.trim($("#title").val()),
                        'poster':$(".from-group-product_img .form-control img").attr('src')?$(".from-group-product_img .form-control img").attr('src').split('?')[0]:'',
                        'keywords':$.trim($("#keywords").val()),
                        'description':$.trim($("#description").val()),
                        'excerpt':$.trim($("#excerpt").val()),
                        'content':ue.getContent(),
                        'sort':$.trim($("#sort").val()),
                        'attached_file_link':$.trim($("#attached_file_link").prev().find('a').text())==''?'':$("#attached_file_link").prev().find('a').attr('href'),
                        'attached_file_name':$("#attached_file_link").prev().find('a').text(),
                        'tags':tags

                    },function(data){
                        layer.msg(data,{time:600},function(){
                            var categoryPidInfo = <%-categoryPidInfo.id-%>;
                            if(categoryPidInfo==1){
                               // window.top.openMenu($(window.top.document).find('[data-index=10]'));
                                window.top.freshList();
                            }
                            if(categoryPidInfo==2){
                               // window.top.openMenu($(window.top.document).find('[data-index=5]'));
                                window.top.freshCaseList();
                            }
                            if(categoryPidInfo==3){
                               // window.top.openMenu($(window.top.document).find('[data-index=6]'));
                                window.top.freshProductList();
                            }
                            var index = window.top.layer.getFrameIndex(window.name);
                            window.top.layer.close(index);
                        });
                    })
                }
            });

        <% } %>
    });

</script>

</html>