<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta charset="utf-8" />
    <meta name="viewport"
        content="width=device-width,initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0">
    <title>微笑</title>
    <script type="text/javascript" src="scripts/rem.js"></script>
    <link rel="stylesheet" href="styles/default.css" />
    <link rel="stylesheet" href="styles/reset.css" />
    <link rel="stylesheet" href="styles/iconfont/iconfont.css" />
    <link rel="stylesheet" href="styles/swiper-bundle.min.css" />
</head>
<body>
    <div class="wp wp-chat_box">
        <div class="topbar topbar_fixed">
            <div class="topbar_inner">
                <div class="topbar_l">
                    <a href="" class="btn-back">
                        <div class="icon-wp">
                            <span class="iconfont icon-arr_l"></span>
                        </div>
                    </a>
                </div>
                <div class="topbar_c">
                    微笑
                </div>
                <div class="topbar_r">
                    <a href="" class="btn-more">
                        <div class="icon-wp">
                            <span class="iconfont icon-more"></span>
                        </div>
                    </a>
                </div>  
            </div>
        </div>
        <div class="list-chat_box">
            <div class="time">
                今天 15:30
            </div>
            <div class="item">
                <div class="avatar" style="background-image: url(images/avatar1.png);"></div>
                <div class="content">
                    <div class="content_inner">
                        哈喽呀
                    </div>
                </div>
            </div>
            <div class="item item-my">
                <div class="avatar" style="background-image: url(images/avatar2.png);"></div>
                <div class="content">
                    <div class="content_inner">
                        在干吗呢
                    </div>
                </div>
            </div>
            <div class="item">
                <div class="avatar" style="background-image: url(images/avatar1.png);"></div>
                <div class="content">
                    <div class="img_wp">
                        <img src="images/img_chat.jpg" class="img" alt="">
                    </div>
                </div>
            </div>
            <div class="item item-my">
                <div class="avatar" style="background-image: url(images/avatar2.png);"></div>
                <div class="content">
                    <div class="content_inner">
                        以雪山主峰为中心，共有八个圈谷构造环绕，其中规模最大的为一号圈谷与北棱角下
                    </div>
                </div>
            </div>
            <div class="item item-my">
                <div class="avatar" style="background-image: url(images/avatar2.png);"></div>
                <div class="content">
                    <div class="content_inner">
                        在干吗呢
                    </div>
                </div>
            </div>
            <div class="item">
                <div class="avatar" style="background-image: url(images/avatar1.png);"></div>
                <div class="content">
                    <div class="img_wp">
                        <img src="images/img_chat.jpg" class="img" alt="">
                    </div>
                </div>
            </div>
            <div class="item item-my">
                <div class="avatar" style="background-image: url(images/avatar2.png);"></div>
                <div class="content">
                    <div class="content_inner">
                        以雪山主峰为中心，共有八个圈谷构造环绕，其中规模最大的为一号圈谷与北棱角下
                    </div>
                </div>
            </div>
        </div>
        <div class="form-chat_box">
            <div class="container">
                <button class="btn-speech">
                    <span class="iconfont icon-speech"></span>
                </button>
                <div class="textarea_wp">
                    <div class="input_txt" id="textareaChatInputTxt"></div>
                    <textarea name="" id="textareaChatInput" cols="30" rows="10" class="textarea" placeholder="请输入内容"></textarea>
                </div>
                <div class="btn-group">
                    <button class="btn-expression">
                        <span class="iconfont icon-expression"></span>
                    </button>
                    <button class="btn-upload">
                        <span class="iconfont icon-upload"></span>
                    </button>
                    <button class="btn-send">发送</button>
                </div>
            </div>
            <div class="tool-emoji">
                <div class="swiper swiper-emoji">
                    <div class="swiper-wrapper">
                      <!-- <div class="swiper-slide"><img src="images/ad_buycar.jpg" alt=""></div>
                      <div class="swiper-slide">Slide 2</div>
                      <div class="swiper-slide">Slide 3</div> -->
                    </div>
                </div>
                <div class="swiper-pagination"></div>
                <button class="btn-emoji_del"><img src="images/emoji_del.svg" alt=""></button>
            </div>
            <div class="tool-more">
                <button class="item">
                    <div class="icon-wp">
                        <img src="images/album.svg" alt="">
                    </div>
                    相册
                </button>
                <button class="item">
                    <div class="icon-wp">
                        <img src="images/camera.svg" alt="">
                    </div>
                    拍摄
                </button>
                <button class="item">
                    <div class="icon-wp">
                        <img src="images/businesscard.svg" alt="">
                    </div>
                    名片
                </button>
                <button class="item">
                    <div class="icon-wp">
                        <img src="images/group.svg" alt="">
                    </div>
                    群名片
                </button>
                <button class="item">
                    <div class="icon-wp">
                        <img src="images/file.svg" alt="">
                    </div>
                    文件
                </button>
                <button class="item">
                    <div class="icon-wp">
                        <img src="images/hongbao.svg" alt="">
                    </div>
                    红包
                </button>
            </div>
        </div>
    </div>
</body>
<script type="text/javascript" src="scripts/jquery.min.js"></script>
<script type="text/javascript" src="scripts/emoji.js"></script>
<script type="text/javascript" src="scripts/swiper-bundle.min.js"></script>
<script type="text/javascript" src="scripts/common.js"></script>
<script type="text/javascript">
    $(function(){
        setTimeout(function(){
            $(".list-chat_box").scrollTop($(".list-chat_box")[0].scrollHeight);
        },100);
        document.getElementById('textareaChatInput').addEventListener('input',function(){
            document.getElementById('textareaChatInputTxt').innerText = document.getElementById('textareaChatInput').value;
            if(document.getElementById('textareaChatInputTxt').innerText==''){
            $(".form-chat_box .btn-send").removeClass('active'); 
            $(".form-chat_box .btn-upload").show(0);  
            }else{
                $(".form-chat_box .btn-upload").hide(0);  
                $(".form-chat_box .btn-send").addClass('active');   
            }
            $(".list-chat_box").scrollTop($(".list-chat_box")[0].scrollHeight);
        })
        //初始化表情
        var EmojiHtmls = '';EmojiHtmlsTemp = '<div class="swiper-slide">';
        emojiArr.forEach((emoji,index)=>{
            EmojiHtmlsTemp += '<button class="btn-emoji">' + emoji.unicode + '</button>';
            if((index+1)%27==0){
                EmojiHtmlsTemp += '</div>';
                EmojiHtmls += EmojiHtmlsTemp;
                EmojiHtmlsTemp = '<div class="swiper-slide">';
            }
            if((index+1)%27 > 0){
                if (index === emojiArr.length-1) {
                    EmojiHtmlsTemp += '</div>';
                    EmojiHtmls += EmojiHtmlsTemp;
                }
            }
        })
        $(".swiper-emoji .swiper-wrapper").html(EmojiHtmls);
        var swiper = new Swiper(".swiper-emoji", {
                            loop:false,
                            autoplay: false,
                            pagination: {
                            el: ".tool-emoji .swiper-pagination",
                            clickable: true,
                            renderBullet: function (index, className) {
                                return '<span class="' + className + '">' + (index + 1) + "</span>";
                            },
                            },
                        });
        //初始化表情结束
        //表情输入
        $(".tool-emoji").delegate('.btn-emoji','click',function(e){
                var emojiTxt = $.trim($(this).text());
                const start = $("#textareaChatInput")[0].selectionStart;
                const end = $("#textareaChatInput")[0].selectionEnd;
                $("#textareaChatInput").val($("#textareaChatInput").val().slice(0, start) + emojiTxt + $("#textareaChatInput").val().slice(end));
                $("#textareaChatInput").focus();
                $("#textareaChatInput")[0].selectionEnd = start + emojiTxt.length;
                // 创建一个 InputEvent 对象
                const inputEvent = new InputEvent('input', {
                    bubbles: true,
                    cancelable: true
                });
                // 使用 dispatchEvent() 方法触发 input 事件
                $("#textareaChatInput")[0].dispatchEvent(inputEvent);
        });
        //表情删除
        $(".tool-emoji .btn-emoji_del").click(function(){
            const start = $("#textareaChatInput")[0].selectionStart;
            const end = $("#textareaChatInput")[0].selectionEnd;
            if(start===0){
                $("#textareaChatInput").focus();
                $("#textareaChatInput")[0].selectionEnd = start;
                return;
            }
            var inputText = $("#textareaChatInput").val();
            var preInputArr = Array.from(inputText.slice(0, start));
            var delText = preInputArr.pop();
            $("#textareaChatInput").val(preInputArr.join('') + inputText.slice(end));
            $("#textareaChatInput").focus();
            $("#textareaChatInput")[0].selectionEnd = start-delText.length;
            // 创建一个 InputEvent 对象
            const inputEvent = new InputEvent('input', {
                bubbles: true,
                cancelable: true
            });
            // 使用 dispatchEvent() 方法触发 input 事件
            $("#textareaChatInput")[0].dispatchEvent(inputEvent);
        });
        //表情列表显示隐藏
        $(".form-chat_box .btn-expression").click(function(){
            $(".tool-more").removeClass('show');
            if($(".tool-emoji").hasClass('show')){
                $(".tool-emoji").removeClass('show');
            }else{
                $("#textareaChatInput").focus();
                $(".tool-emoji").addClass('show');
            }

            $(".list-chat_box").scrollTop($(".list-chat_box")[0].scrollHeight);

        });
        $(document).delegate('*','click',function(e){
            if ($(".form-chat_box .textarea_wp").find(e.target).length>0||$(".form-chat_box .btn-expression").find(e.target).length>0||$(".form-chat_box .btn-expression")[0]==e.target) {
                return;
            }
            if($(".form-chat_box .tool-emoji").find(e.target).length==0){
                $(".form-chat_box .tool-emoji").removeClass('show');
            }
        })

        //其他工具显示隐藏
        $(".form-chat_box .btn-upload").click(function(){
            $(".tool-emoji").removeClass('show');
            $(".tool-more").toggleClass('show');
            $(".list-chat_box").scrollTop($(".list-chat_box")[0].scrollHeight);
        });
        $(document).delegate('*','click',function(e){
            if ($(".form-chat_box .btn-upload").find(e.target).length>0||$(".form-chat_box .btn-upload")[0]==e.target) {
                return;
            }
            if($(".form-chat_box .tool-more").find(e.target).length==0){
                $(".form-chat_box .tool-more").removeClass('show');
            }
        })
    });
</script>
</html>